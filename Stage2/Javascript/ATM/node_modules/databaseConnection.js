//Start the server.js before changing anything here...this file is not the problem
const mysql = require('mysql2');
const selectNameStatement = "SELECT customerId, CONCAT(customerFName, customerLName) as customerName, customerBalance FROM customers WHERE customeraccountno = ? AND customerPin = ?";
const selectNotesStatement = "SELECT cash_id, notes, count from cash";
const updateNotesStatement = "update cash set count = ? where cash_id = ?";
const updateUserBalanceStatement = "update customers set customerBalance = ? where customerId = ?"
const database = "atm";
const password = "ohitsme"
const user = "abdalghany";
const host = "localhost";

function fetchPasswordFromDb(userAccountNo, userAccountPin, callback){
  var con = mysql.createConnection({
    host: host,
    user: user,
    password: password,
    database: database
  });
  con.connect(function(err) {
    if (err) return callback(err, null);
    con.query(selectNameStatement, [userAccountNo, userAccountPin], function(err, result, fields) {
      con.end(); // Close the connection after the query
      if (err){callback(err, null);}
      if (result && result.length > 0) {
        callback(null, result[0].customerId, result[0].customerName, result[0].customerBalance);

      } else {
        callback(null, "User does not exist");

      }
    });
  });
}

function fetchNotes(callback){
  var con = mysql.createConnection({
    host: host,
    user: user,
    password: password,
    database: database
  });
  con.connect(function(err) {
    if (err) return callback(err, null);
    con.query(selectNotesStatement, function(err, result, fields) {
      con.end(); // Close the connection after the query
      if (err){callback(err, null);}
      if (result && result.length > 0) {
        var resultID = [];
        var resultNotes = [];
        var resultCount = [];
        for(let i = 0; i< result.length;i++){
          resultID.push(result[i].cash_id);
          resultNotes.push(result[i].notes);
          resultCount.push(result[i].count);
        }
        callback(null, resultID, resultNotes, resultCount);
      } else {
        callback(null, "Money does not exist");

      }
    });
  });
}

function updateUserBalance(customerId, customerBalance, callback){
  var con = mysql.createConnection({
    host: host,
    user: user,
    password: password,
    database: database
  });

  con.connect(function(err) {
    if (err) return callback(err, null);

    con.query(updateUserBalanceStatement, [customerBalance, customerId], function(err, result, fields) {
      con.end(); // Close the connection after the query
      if (err){callback(err, null);}
      // If update is successful
      if (result.affectedRows > 0) {
        callback(null, customerId, customerBalance);
      }  else {
        callback(null, "User does not exist");

      }
    });
  });
}

function updateNoteCount(RMNotesId, RMNotesAvailable, callback){
  var con = mysql.createConnection({
    host: host,
    user: user,
    password: password,
    database: database
  });

  con.connect(function(err) {
    if (err) return callback(err, null);
    
    con.query(updateNotesStatement, [RMNotesAvailable, RMNotesId], function(err, result, fields) {
      con.end(); // Close the connection after the query
      if (err){callback(err, null);}
      // If update is successful
      if (result.affectedRows > 0) {
        callback(null, RMNotesAvailable, RMNotesId);
      }  else {
        callback(null, "Note does not exist");

      }
    });
  });
}

module.exports.fetchUserPassword = fetchPasswordFromDb;
module.exports.fetchNotes = fetchNotes;
module.exports.updateUserBalance = updateUserBalance;
module.exports.updateNoteCount = updateNoteCount;